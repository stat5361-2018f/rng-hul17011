---
title: "Rejection sampling"
output: pdf_document
author: "Hukai Luo"
date: "`r format(Sys.time(), '%d %B %Y')`"
abstract:
    In this assignment we will express how to use the rejection sampling to sample from some distributions using what we've learned.
---

# 1 Rejection sampling

Let $f$ and $g$ be two probability densities on $(0,\infty)$, such that
\begin{align*}
  f(x) \propto \sqrt{4+x}\,x^{\theta-1} e^{-x}, \quad
  g(x) \propto (2 x^{\theta-1} + x^{\theta-1/2}) e^{-x}, \quad x>0.
\end{align*}

- Find the value of the normalizing constant for $g$, i.e.,
  the constant $C$ such that
\begin{align*}
  C\int_0^\infty (2 x^{\theta-1} +  x^{\theta-1/2}) e^{-x}  dx=1.
\end{align*}
  Show that $g$ is a mixture of Gamma distributions.  Identify the
  component distributions and their weights in the mixture.
- Design a procedure (pseudo-code) to sample from $g$;
  implement it in an R function;
  draw a sample of size $n = 10,000$ using your function for at least one
  $\theta$ value; 
  plot the kernel density estimation of $g$ from your sample and the true
  density in one figure. 
- Design a procedure (pseudo-code) to use rejection sampling to sample from
  $f$ using $g$ as the instrumental distribution.  Overlay the estimated
  kernel density of a random sample generated by your procedure and $f$.
  
# 2 Find the value of the normalizing constant

In this question, we need to calculate the normalizing constant for $g$
\begin{align*}
&\int_0^\infty (2 x^{\theta-1} +  x^{\theta-1/2}) e^{-x}dx \\
&=\int_0^\infty 2 x^{\theta-1}e^{-x}dx + \int_0^\infty x^{\theta-1/2} e^{-x}dx\\
&=2\Gamma(\theta)+\Gamma(\theta+\frac{1}{2})
\end{align*}
so that we can get
\[C= \frac{1}{2\Gamma(\theta)+\Gamma(\theta+\frac{1}{2})} \]
next we get the full expression of $g$:
\[g(x) = \frac{1}{2\Gamma(\theta)+\Gamma(\theta+\frac{1}{2})}(2 x^{\theta-1} +  x^{\theta-1/2}) e^{-x}\]
we can change it to another expression:
\[g(x) =  \frac{2 \Gamma(\theta)}{2 \Gamma(\theta) + \Gamma(\theta + \frac{1}{2})} \frac{x^{\theta - 1} e^{-x}}{\Gamma(\theta)}  +  \frac{\Gamma(\theta + \frac{1}{2})}{2 \Gamma(\theta) + \Gamma(\theta + \frac{1}{2})}\frac{x^{(\theta + \frac{1}{2}) - 1} e^{-x}}{\Gamma(\theta + \frac{1}{2})} \]
\newpage
and that $g$ is a mixture of Gamma distributions,the component distribution is $\Gamma(\theta, 1)$ with weight $w1$, and $\Gamma(\theta + \frac{1}{2}, 1)$ with weight $w2$:
\[w1 = \frac{2 \Gamma(\theta)}{2 \Gamma(\theta) + \Gamma(\theta + \frac{1}{2})}, w2 = \frac{\Gamma(\theta + \frac{1}{2})}{2 \Gamma(\theta) + \Gamma(\theta + \frac{1}{2})}\]

# 3 Procedure, sample from $g$

Pseudocode is an informal high-level description of the operating principle of a computer program or other algorithm.
```{r code, results='hide'}
gprocedure <- function(size, theta) {
  
  weight1 = 2 * gamma(theta) / (2 * gamma(theta) + gamma(theta + (1/2)))
  u = runif(size,0,1)
  sample = double(size)
  
  for (i in 1:size) {
    if (u[i] > weight1) {
      sample[i] <- rgamma(1, shape = theta, rate = 1)
    } 
    else {
      sample[i] <- rgamma(1, shape = theta + (1/2), rate = 1)
    }
  }
  return(sample)
}
gfunc <- function(theta, x) {
  g= 1/(2*gamma(theta) + gamma(theta + (1/2)))*(2*x^(theta-1) +  x^(theta-1/2))*exp(-x)
}
```
next let's assume $\theta = 3$, and $size = 10000$
```{r code2, results='hide'}
theta <- 3
size <-10000
sample <- gprocedure(size, theta)
plot(density(sample), col = "red")
curve(gfunc(theta = 3,x), add = TRUE, col = "blue")
legend("topright", legend = c("Procedure sample", "True Density"), 
      col = c("red","blue"), lty = c(1,1))
```

# 4 Rejection sampling, sample from $f$

In this section, we will use g to estimate the distribution of f , and $f(x)\varpropto q(x)=\sqrt{4+x}x^{\theta-1}e^{-x}$, and 
\begin{align*}
\alpha & =\sup_{x>0}\frac{q(x)}{g(x)}\\
       & =\sup_{x>0}\frac{\sqrt{4+x}x^{\theta-1}e^{-x}}{C(2x^{\theta-1}+x^{\theta-\frac{1}{2}})e^{-x}}\\
       & =\sup_{x>0}\frac{\sqrt{4+x}}{C\sqrt{x}}\\
       & =\frac{1}{C}
\end{align*}
which means
$q(x)=\sqrt{4+x}x^{\theta-1}e^{-x}\leqslant \alpha g(x)=\frac{1}{C}g(x)=(2x^{\theta-1}+x^{\theta-\frac{1}{2}})e^{-x}$
```{r code3, results='hide'}
fprocedure <- function(size, theta) {
  iter <- 0
  sample <- double(0)
  while(iter < size) {
    g <- gprocedure(1, theta)
    u <- runif(1,0,1)
    q <- sqrt(4 + g)*((g)^(theta-1))*exp(-1*g)
    r <- q/(2*g^(theta-1) +  g^(theta-1/2))*exp(-g)
    if (u <= r) { 
      sample <- append(sample, g)
      iter <- iter + 1
    }
  }
  return(sample)
}

theta <- 3
size <-10000
sample <- fprocedure(size, theta)
plot(density(sample), col = "red")
```























